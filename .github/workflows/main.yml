name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - "app/**"
      - "api/**"
      - "tests/**"
      - ".github/workflows/**"
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force-deploy:
        description: "Force deployment even if not on main branch"
        required: false
        type: boolean
        default: false

jobs:
  # Detect which parts of the application changed
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api-changed: ${{ steps.changes.outputs.api }}
      app-changed: ${{ steps.changes.outputs.app }}
      tests-changed: ${{ steps.changes.outputs.tests }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        shell: bash
        run: |
          # For push events, check changed files
          if [ "${{ github.event_name }}" == "push" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} || echo "")
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} || echo "")
          else
            # For workflow_dispatch, assume everything changed
            echo "api=true" >> $GITHUB_OUTPUT
            echo "app=true" >> $GITHUB_OUTPUT
            echo "tests=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check for API changes
          if echo "$CHANGED_FILES" | grep -qE '^api/|^.github/workflows/(build-api|main).yml'; then
            echo "api=true" >> $GITHUB_OUTPUT
          else
            echo "api=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for App changes
          if echo "$CHANGED_FILES" | grep -qE '^app/|^.github/workflows/(build-app|main).yml'; then
            echo "app=true" >> $GITHUB_OUTPUT
          else
            echo "app=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for test changes
          if echo "$CHANGED_FILES" | grep -qE '^tests/|^.github/workflows/(e2e-tests|main).yml'; then
            echo "tests=true" >> $GITHUB_OUTPUT
          else
            echo "tests=false" >> $GITHUB_OUTPUT
          fi

  # Build jobs run in parallel
  build-api:
    name: Build API
    needs: detect-changes
    if: needs.detect-changes.outputs.api-changed == 'true' || needs.detect-changes.outputs.tests-changed == 'true'
    uses: ./.github/workflows/build-api.yml

  build-app:
    name: Build App
    needs: detect-changes
    if: needs.detect-changes.outputs.app-changed == 'true' || needs.detect-changes.outputs.tests-changed == 'true'
    uses: ./.github/workflows/build-app.yml

  # E2E tests run after both builds complete
  e2e-tests:
    name: E2E Tests
    needs: [detect-changes, build-api, build-app]
    if: |
      always() &&
      (needs.build-api.result == 'success' || needs.build-api.result == 'skipped') &&
      (needs.build-app.result == 'success' || needs.build-app.result == 'skipped') &&
      (needs.detect-changes.outputs.api-changed == 'true' || 
       needs.detect-changes.outputs.app-changed == 'true' || 
       needs.detect-changes.outputs.tests-changed == 'true')
    uses: ./.github/workflows/e2e-tests.yml

  # Deploy only if on main branch or forced, and only if there were changes
  deploy:
    name: Deploy
    needs: [detect-changes, build-api, build-app, e2e-tests]
    if: |
      always() &&
      needs.e2e-tests.result == 'success' &&
      (github.ref == 'refs/heads/main' || github.event.inputs.force-deploy == 'true')
    uses: ./.github/workflows/deploy.yml
    secrets: inherit
    with:
      deploy-api: ${{ needs.detect-changes.outputs.api-changed == 'true' }}
      deploy-app: ${{ needs.detect-changes.outputs.app-changed == 'true' }}

